 Моя самая глупая ошибка, искать которую мне пришлось долго и очень не просто — это ошибка работы с памятью в *C*.

## Проблемы

1. [Проблема 1] Проблема заключалась в том, что программа начинала выводить очень странные сообщения. Они не приводили к проблемам, но мы абсолютно не знали, откуда они берутся

    >  stderr: Possible lost samples [Num]

    Внутри самой программы таких сообщений нигде не выводилось, поэтому стало понятно, что эти сообщения выдает наш дочерний процесс, в котором работает другая программа (Она отслеживала все открывающиеся файлы). Причем сообщение появляется почти сразу при работе 3 инстансов программы.

1. [Проблема 2] Проблема заключалась в том, что программу убивал *OOM-killer* через 24 часа. 

## Решение

Оказалось, что [Проблема 1] возникает при большом количестве открывающихся файлов в секунду. Поэтому мы начали проводить тесты и искать способы, чтобы увеличить количество файлов, которое может обработать программа в секунду. (Спойлер: проблема была не в этом)

Для решения [Проблемы 2] очевидно использовать *valgrind*. Собственно после анализа программы, исправления всего, про что говорил *valgrind* проблема не ушла. 

## Настоящие решение 

После того, как обычный *valgrind* не показал настоящую проблему, пришлось использовать *valgrind massif*. С помощью него я наконец нашел место, где память выделялась. И проблема была в вызове `fdopen`, который каждый раз возвращал указатель на новый `FILE`, после того, как я начал освобождать память после каждого вызова `fdopen` [Проблема 2] ушла. 

Как оказалось, такая [Проблема 1] может возникать не только от большого количества файлов в секунду, но и если не хватает памяти для буффера. Таким образом [Проблема 2] ушла.  
